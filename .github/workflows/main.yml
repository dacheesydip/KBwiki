# .github/workflows/rst-to-html.yml
name: Convert RST to HTML

on:
  push:
    paths:
      - '**.rst'
  pull_request:
    paths:
      - '**.rst'

jobs:
  convert-rst-to-html:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install docutils
        
    - name: Get changed RST files
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files: |
          **.rst
          
    - name: Convert RST files to HTML
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        # Create conversion script
        cat > convert_rst.py << 'EOF'
        import os
        import sys
        from docutils.core import publish_file
        from docutils.writers.html4css1 import Writer, HTMLTranslator
        from docutils.parsers.rst import directives
        from docutils.parsers.rst.directives import unchanged
        from docutils import nodes
        
        # Custom directive to preserve raw HTML
        class RawHTMLDirective(directives.unchanged.Unchanged):
            """Directive to preserve raw HTML content"""
            required_arguments = 0
            optional_arguments = 0
            final_argument_whitespace = True
            has_content = True
            option_spec = {}
            
            def run(self):
                # Join all content lines and create a raw HTML node
                html_content = '\n'.join(self.content)
                raw_node = nodes.raw('', html_content, format='html')
                return [raw_node]
        
        # Register the directive
        directives.register_directive('raw-html', RawHTMLDirective)
        
        # Custom HTML translator to handle raw HTML preservation
        class PreservingHTMLTranslator(HTMLTranslator):
            def visit_raw(self, node):
                if node.get('format') == 'html':
                    self.body.append(node.astext())
                else:
                    HTMLTranslator.visit_raw(self, node)
                    
            def depart_raw(self, node):
                if node.get('format') != 'html':
                    HTMLTranslator.depart_raw(self, node)
        
        # Custom writer
        class PreservingHTMLWriter(Writer):
            def __init__(self):
                Writer.__init__(self)
                self.translator_class = PreservingHTMLTranslator
        
        def convert_rst_to_html(rst_file):
            # Determine output HTML file path
            html_file = os.path.splitext(rst_file)[0] + '.html'
            
            # Read RST content and preprocess it
            with open(rst_file, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # Wrap existing HTML blocks with raw-html directive
            import re
            
            # Pattern to match HTML blocks (simple heuristic)
            html_pattern = r'(<[^>]+>.*?</[^>]+>)'
            
            def wrap_html(match):
                html_content = match.group(1)
                # Only wrap if it looks like a complete HTML tag
                if '</' in html_content and html_content.strip().startswith('<'):
                    return f'\n\n.. raw-html::\n\n   {html_content}\n\n'
                return html_content
            
            # Apply the wrapping (be conservative to avoid breaking valid RST)
            processed_content = re.sub(html_pattern, wrap_html, content, flags=re.DOTALL)
            
            # Write processed content to temporary file
            temp_rst = rst_file + '.tmp'
            with open(temp_rst, 'w', encoding='utf-8') as f:
                f.write(processed_content)
            
            try:
                # Convert to HTML
                with open(temp_rst, 'rb') as source:
                    with open(html_file, 'wb') as destination:
                        publish_file(
                            source=source,
                            destination=destination,
                            writer=PreservingHTMLWriter(),
                            settings_overrides={
                                'input_encoding': 'utf-8',
                                'output_encoding': 'utf-8',
                                'embed_stylesheet': False,
                                'raw_enabled': True,
                                'file_insertion_enabled': False,
                                'halt_level': 2,
                                'report_level': 2,
                            }
                        )
                print(f"✓ Converted {rst_file} to {html_file}")
                return html_file
            finally:
                # Clean up temporary file
                if os.path.exists(temp_rst):
                    os.remove(temp_rst)
        
        if __name__ == "__main__":
            changed_files = sys.argv[1:]
            converted_files = []
            
            for rst_file in changed_files:
                if rst_file.endswith('.rst') and os.path.exists(rst_file):
                    try:
                        html_file = convert_rst_to_html(rst_file)
                        converted_files.append(html_file)
                    except Exception as e:
                        print(f"✗ Error converting {rst_file}: {e}")
                        sys.exit(1)
            
            # Output list of converted files for next step
            if converted_files:
                with open('converted_files.txt', 'w') as f:
                    f.write('\n'.join(converted_files))
        EOF
        
        # Run conversion on changed files
        python convert_rst.py ${{ steps.changed-files.outputs.all_changed_files }}
        
    - name: Commit and push changes
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add converted HTML files
        if [ -f "converted_files.txt" ]; then
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              git add "$file"
              echo "Added $file to git"
            fi
          done < converted_files.txt
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-update HTML files from RST changes
            
            Updated files:
            $(cat converted_files.txt | sed 's/^/- /')"
            
            git push
          fi
        fi
